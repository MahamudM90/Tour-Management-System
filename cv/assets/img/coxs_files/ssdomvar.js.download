/* Copyright 2017, SiteSpect, Inc. All Rights Reserved. */
var ss_dom_var=function(){"use strict";var MAX_APPLICATIONS=1e3;var THROTTLE_TIME=1e3;var variations=[];var metrics=[];var timestamps={};var checkCriteria;var asmtRequest;var metricRequest;var asmtCallback;var is_ve_edit_mode=false;var ignore_variation_mutations=false;var pause_variations=false;var variationWatchers=[];var variations_applied={};var variations_by_target=[];var target_indices=[];var observer;var counted_tcs={};var observer_options={childList:true,attributes:true,characterData:true,subtree:true};var flag_attr="data-ss-variation-applied";var case_insensitive_comment="(?#i)";var asmtCallbackDefault=function(ret){var SS=window.SS||{};SS.getAsmtData=function(){return ret};window.SS=SS};asmtCallbackDefault();var applySingleVariation=function(){try{observer=new MutationObserver(mutationsOccurred)}catch(ex){}function mutationsOccurred(mutation_records){mutation_records.forEach(function(mutation){var target=getNormalizedMutationTarget(mutation.target);if(!ignore_variation_mutations&&document.body.contains(target)){var variations_to_apply=findVariationsForTarget(target);if(variations_to_apply){variations_to_apply.forEach(function(variation){executeVariation(target,variation)})}}});cleanup()}function getNormalizedMutationTarget(target){var fallback;var candidate=target;while(candidate){if(candidate.nodeType===Node.ELEMENT_NODE){fallback=fallback||candidate;if(candidate.getAttribute(flag_attr)||target_indices.indexOf(target)>-1){return candidate}}candidate=candidate.parentNode}return fallback}function cleanup(){target_indices.forEach(function(target,index){if(!document.querySelector("["+flag_attr+'="'+index+'"]')){delete target_indices[index];delete variations_by_target[index]}})}function applyHtmlChange(target,html){target.innerHTML=html}function applyCssChange(target,props){Object.keys(props).forEach(function(prop){target.style[prop]=props[prop]})}function applyAttributesChange(target,atts){Object.keys(atts).forEach(function(att){target.setAttribute(att,atts[att])})}function applyCustomChange(target,code){try{code.apply(target)}catch(ex){return false}}function applyVariation(variation){if(!variation.selector){return 0}if(!checkCriteria(variation)){return 0}var targets=document.querySelectorAll(variation.selector);var changes_made=0;var i;for(i=0;i<targets.length;i++){if(is_ve_edit_mode&&typeof __ssedit!=="undefined"&&__ssedit.isVEContent(targets[i])){continue}changes_made+=registerVariation(targets[i],variation)}return changes_made}function findVariationsForTarget(target){var variations_index=target.getAttribute(flag_attr);if(variations_index===null){variations_index=target_indices.indexOf(target);if(variations_index===-1){variations_index=target_indices.length;target_indices[variations_index]=target;if(observer&&!ignore_variation_mutations){observer.observe(target,observer_options)}}target.setAttribute(flag_attr,variations_index)}var these_variations=variations_by_target[variations_index];if(!these_variations){these_variations=variations_by_target[variations_index]=[]}return these_variations}function registerVariation(target,variation){var these_variations=findVariationsForTarget(target);if(these_variations.indexOf(variation)===-1){these_variations.push(variation);return executeVariation(target,variation)}return 0}function executeVariation(target,variation){if(!checkCriteria(variation)){return}var target_cloned;var timestamp=(new Date).getTime();var remove_index=0;if(pause_variations){return}while(remove_index<variation.applied.length&&variation.applied[remove_index]+THROTTLE_TIME<timestamp){remove_index++}variation.applied.push(timestamp);if(remove_index){variation.applied.splice(0,remove_index)}if(variation.applied.length>=MAX_APPLICATIONS){console.warn("Possible infinite loop detected, aborting");return 0}if(is_ve_edit_mode){target_cloned=target.ss_revert||target.cloneNode(true)}if(variation.html){applyHtmlChange(target,variation.html)}if(variation.css){applyCssChange(target,variation.css)}if(variation.attributes){applyAttributesChange(target,variation.attributes)}if(variation.custom){applyCustomChange(target,variation.custom)}if(target.hasAttribute("data-sspvid")){var new_target=document.querySelector(variation.selector);if(variation.custom&&!new_target&&variation.attributes&&variation.attributes["data-sspvid"]){new_target=document.querySelector('[data-sspvid="'+variation.attributes["data-sspvid"]+'"]')}if(new_target){if(variation.custom){var attributes=["data-sspvid","data-ss-sole-change","data-sspv-control","data-ss-fe-edit-type","data-ss-display-name","data-ss-orig-order","data-ssmid","data-ss-metric-name"];attributes.forEach(function(attribute){if(target.hasAttribute(attribute)){new_target.setAttribute(attribute,target.getAttribute(attribute))}});var insert_attrs=Array.prototype.slice.call(target.attributes).filter(function(attribute){return attribute.name.match(/^data-ss-(?:control-)?reference-node-/)});insert_attrs.forEach(function(attr){new_target.setAttribute(attr.name,attr.value)})}if(is_ve_edit_mode){if(target_cloned){new_target.ss_revert=target_cloned}if(typeof __ssedit!=="undefined"){__ssedit.outlineEdited(new_target)}}if(!new_target.hasAttribute(flag_attr)&&target.hasAttribute(flag_attr)){new_target.setAttribute(flag_attr,target.getAttribute(flag_attr));var target_index=target_indices.indexOf(target);if(target_index>-1){target_indices[target_index]=new_target}if(observer&&!ignore_variation_mutations){observer.observe(new_target,observer_options)}}}}else if(target.hasAttribute("data-ssmid")&&is_ve_edit_mode){if(typeof __ssedit!=="undefined"){__ssedit.outlineEdited(target)}}if(observer){observer.takeRecords()}return 1}function setVariationPreview(variation_id,changes_count){variations_applied[variation_id]=variations_applied[variation_id]||0;variations_applied[variation_id]+=changes_count;var preview_applied_selector="#ssp_history_panel .ss_csf_applied_"+variation_id;var preview_applied_elements=document.querySelectorAll(preview_applied_selector);for(var i=0;i<preview_applied_elements.length;i++){if(variations_applied[variation_id]){preview_applied_elements[i].style.display="block"}else{preview_applied_elements[i].style.display="none"}}}return function(variation){var changes_made=0;changes_made=applyVariation(variation);if(changes_made&&!variation.counted&&variation.trigger_counted&&!counted_tcs[variation.campaign_id]){variation.counted=true;counted_tcs[variation.campaign_id]=true;if(typeof asmtCallback!=="function"){asmtCallback=asmtCallbackDefault}asmtRequest(asmtCallback,counted_tcs)}setVariationPreview(variation.id,changes_made);return changes_made}}();function applyVariations(variations_list){if(!(variations_list instanceof Array)){variations_list=variations}var changes_made=variations_list.map(applySingleVariation).reduce(function(sum,current){return sum+current},0);return changes_made}function isInverted(regex_string){return!!(regex_string&&regex_string.match(/\(\?#[^)]+_ss-invert\)/))}function removeRegexComments(regex){return regex.replace(/\(\?#[^)]*\)/g,"")}function createRegex(criterion_value){var flag=criterion_value.indexOf(case_insensitive_comment)!==-1?"i":"";var normalized_value=removeRegexComments(criterion_value);return new RegExp(normalized_value,flag)}function isDefined(value){return typeof value!=="undefined"&&value!==null}checkCriteria=function(){function checkCriterionCustom(criterion){try{return criterion.script_criterion()}catch(ex){return false}}function checkCriterionHash(criterion){var ret_val=!!document.location.hash.match(createRegex(criterion.hash_criterion));if(isInverted(criterion.hash_criterion)){ret_val=!ret_val}return ret_val}function checkCriterionHashQuery(criterion){var index=document.location.hash.indexOf("?")+1,parts=[""];if(index){parts=document.location.hash.substring(index).split("&")}return checkForKeyValuePair(criterion.hashquery_name_criterion,criterion.hashquery_value_criterion,parts)}function checkCriterionPath(criterion){var ret_val=!!document.location.pathname.match(createRegex(criterion.path_criterion));if(isInverted(criterion.path_criterion)){ret_val=!ret_val}return ret_val}function checkCriterionQuery(criterion){var parts=document.location.search.substring(1).split("&");return checkForKeyValuePair(criterion.query_name_criterion,criterion.query_value_criterion,parts)}function checkForKeyValuePair(criterion_key,criterion_value,candidates){var key_regex_is_inverted=isInverted(criterion_key),value_regex_is_inverted=isInverted(criterion_value),key_regex=createRegex(criterion_key),value_regex=createRegex(criterion_value),i,split,key,value,key_satisfies,value_satisfies;for(i=0;i<candidates.length;i++){split=candidates[i].split("=");key=split.shift();key_satisfies=!!key.match(key_regex);if(key_regex_is_inverted){key_satisfies=!key_satisfies}if(key_satisfies){value=split.join("=");value_satisfies=!!value.match(value_regex);if(value_regex_is_inverted){value_satisfies=!value_satisfies}if(value_satisfies){break}}}return key_satisfies&&value_satisfies}return function(variation){var i,crit,dispatch={Path:checkCriterionPath,Hash:checkCriterionHash,Query:checkCriterionQuery,HashQuery:checkCriterionHashQuery,Custom:checkCriterionCustom};var pre_passed=false;for(i=0;i<variation.criteria.length;i++){crit=variation.criteria[i];if(isDefined(crit.GroupNumber)&&pre_passed&&isDefined(crit.Pre)&&isDefined(variation.criteria[crit.Pre])&&crit.GroupNumber===variation.criteria[crit.Pre].GroupNumber){continue}pre_passed=dispatch[crit.Type]&&dispatch[crit.Type](crit);if(!pre_passed){if(!(isDefined(crit.GroupNumber)&&isDefined(crit.Next)&&isDefined(variation.criteria[crit.Next])&&crit.GroupNumber===variation.criteria[crit.Next].GroupNumber)){return false}}}return true}}();asmtRequest=engineRequest("/__ssobj/asmt_update");metricRequest=engineRequest("/__ssobj/api");function engineRequest(target){var timeout_id,delay=100,payloadObj,dataHandler;function flushQueue(){reset();var payload=JSON.stringify(payloadObj),xhr=new XMLHttpRequest;xhr.open("POST",target);xhr.setRequestHeader("Context-Type","application/json;charset=UTF-8");xhr.addEventListener("load",handleResponse,false);xhr.send(payload)}function handleResponse(evt){var data;try{data=JSON.parse(evt.target.response);if(typeof dataHandler==="function"){dataHandler(data,this)}trackingPreviewLoaded(data,0)}catch(ex){}}function initializePing(force){if(force&&timeout_id){reset()}else if(timeout_id){return}timeout_id=setTimeout(flushQueue,delay)}function reset(){clearTimeout(timeout_id);timeout_id=null}return function(handler,payload){dataHandler=handler;payloadObj=payload;if(!timeout_id){initializePing()}}}function trackingPreviewLoaded(data,count){if(typeof window.__sscCSFCountStatusChange==="undefined"&&count<5){setTimeout(function(){trackingPreviewLoaded(data,count+1)},1e3)}else{if(typeof window.__sscCSFCountStatusChange!=="undefined"){window.__sscCSFCountStatusChange.forEach(function(ready_function){ready_function(data)})}}}function setIgnoreVariationMutationsOnDelay(args){setTimeout(function(){ignore_variation_mutations=!!args.is_ve_edit_mode},5e3)}function setVariations(a){if(a){variations=a.variations||variations;timestamps=a.timestamps||timestamps;setIgnoreVariationMutationsOnDelay(a);is_ve_edit_mode=!!a.is_ve_edit_mode}variations.forEach(function(variation){variation.applied=variation.applied||[]});variationWatchers.forEach(function(callback){callback(variations)})}function setMetrics(a){metrics=a?a.metrics||metrics:metrics}function registerVariationWatcher(callback){variationWatchers.push(callback);callback(variations)}function checkVariationApplied(variation_id){return variations_applied[variation_id]||0}function setAsmtCallback(callback){asmtCallback=callback}setVariations(window.__ss_variations);setMetrics(window.__ss_variations);document.addEventListener("ready",function(){if(!variations.length){setVariations(window.__ss_variations)}if(!metrics.length){setMetrics(window.__ss_variations)}},false);function pauseVariations(){if(is_ve_edit_mode){pause_variations=true}}function unpauseVariations(){if(is_ve_edit_mode){pause_variations=false}}function updateVariationSelector(args){var attr_key=args.identifying_attr_key;var attr_value=args.identifying_attr_val;var script_content_regex=args.identifying_script_content_regex;var new_selector=args.new_selector;if(!is_ve_edit_mode){return}Object.keys(variations).forEach(function(variation_index){var variation=variations[variation_index];if(attr_key&&variation.attributes&&variation.attributes[attr_key]&&variation.attributes[attr_key]===attr_value||script_content_regex&&variation.custom&&variation.custom.toString().match(script_content_regex)){variation.selector=new_selector}})}function isSafeToEdit(el){var is_safe=true;if(variations.length&&!ignore_variation_mutations){var edit_id=el.getAttribute("data-sspvid");if(edit_id){is_safe=variations.some(function(variation){if(variation.attributes&&variation.attributes["data-sspvid"]===edit_id){var is_reorder=el.getAttribute("data-ss-fe-edit-type")==="frontend_order";return!variation.custom||is_reorder}})}}return is_safe}function generateMetricsPayload(metrics){var asmt_counted_vgs=[];var payload={visits:[{AsmtCounted:[],Data:{}}]};metrics.forEach(function(metric){payload.visits[0].Data[metric.id]={Hits:1};if(metric.trigger_counting){metric.vg_ids.forEach(function(vg_id){if(asmt_counted_vgs.indexOf(vg_id)<=-1){asmt_counted_vgs.push(vg_id)}})}});if(asmt_counted_vgs.length>0){payload.visits[0].AsmtCounted=asmt_counted_vgs}return payload}function evaluateMetrics(){var evaluated_metrics=[];metrics.forEach(function(metric){if(checkCriteria(metric)){evaluated_metrics.push(metric)}});if(evaluated_metrics.length>0){metricRequest(function(data,req){function trackingPreviewLoaded(req,count){if(typeof window.__ssmCSMetricResponseReadyChange==="undefined"&&count<5){setTimeout(function(){trackingPreviewLoaded(req,count+1)},1e3)}else{if(typeof window.__ssmCSMetricResponseReadyChange!=="undefined"){window.__ssmCSMetricResponseReadyChange.forEach(function(ready_function){ready_function(req.getResponseHeader("SiteSpect-Metrics-Info"))})}}}trackingPreviewLoaded(req,0)},generateMetricsPayload(evaluated_metrics))}}return{applyVariations:applyVariations,applySingleVariation:applySingleVariation,setVariations:setVariations,setMetrics:setMetrics,registerVariationWatcher:registerVariationWatcher,checkVariationApplied:checkVariationApplied,setAsmtCallback:setAsmtCallback,pauseVariations:pauseVariations,unpauseVariations:unpauseVariations,updateVariationSelector:updateVariationSelector,isSafeToEdit:isSafeToEdit,evaluateMetrics:evaluateMetrics}}();(function(){"use strict";function dynamicModifyContent(args){var options={childList:true,attributes:true,subtree:true};var observedObject;var observer;var initMutationObserver;var callback=args.callback;var static_container=document.querySelector("html");if(static_container){if(window.MutationObserver){observer=new MutationObserver(executeCallback);observedObject=static_container;initMutationObserver=observer.observe.bind(observer,observedObject,options);initMutationObserver()}else{addMutationListener(static_container)}}function addMutationListener(node){node.addEventListener("DOMSubtreeModified",mutationEventCallback,false)}function removeMutationListener(node){node.removeEventListener("DOMSubtreeModified",mutationEventCallback,false)}function executeCallback(){if(observer){observer.disconnect()}var targets=document.querySelectorAll(args.selector);if(targets.length>0){callback()}if(initMutationObserver){initMutationObserver()}}function mutationEventCallback(){removeMutationListener(static_container);executeCallback();addMutationListener(static_container)}}ss_dom_var.registerVariationWatcher(function(variations){variations.forEach(function(variation){dynamicModifyContent({selector:variation.selector,callback:ss_dom_var.applySingleVariation.bind(ss_dom_var,variation)})})});var cached_location=null;setInterval(function(){if(cached_location===null||cached_location!==window.location.href){cached_location=window.location.href;ss_dom_var.evaluateMetrics()}},500)})();